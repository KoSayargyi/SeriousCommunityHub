<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{index::head}">
    <meta charset="UTF-8">
    <title>Policy</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
        }

        .main {
            padding: 20px;
        }

        .policy-container {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .policy {
            margin-bottom: 20px;
        }

        .policy p {
            font-size: 16px;
            line-height: 1.5;
            color: #333333;
        }

        .policy hr {
            border: 0;
            height: 1px;
            background: #e0e0e0;
            margin: 20px 0;
        }

        /* CSS for the edit button */
        .edit-button {
            background-color: #007bff; /* Button color */
            color: #fff; /* Text color */
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .edit-button:hover {
            background-color: #0056b3; /* Darker shade on hover */
        }

        /* CSS for the delete button */
        .delete-button {
            background-color: #dc3545; /* Red button color */
            color: #fff; /* Text color */
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-button:hover {
            background-color: #c82333; /* Darker shade on hover */
        }
    </style>
</head>
<body>
<div th:replace="~{index::header}"></div>
<div th:replace="~{index::navbar}"></div>
<main id="main" class="main">
    <div class="policies">
        <h2>Our Term&Condition</h2>
        <div class="policy-container"></div>
    </div>
    <div class="custom-modal" id="updatePolicyModal" >
        <link href="/static/assets/css/policy_modal.css" rel="stylesheet">
        <div class="custom-modal-dialog">
            <div class="custom-modal-content">
                <div class="custom-modal-header">
                    <h5 class="custom-modal-title">Update Policy</h5>
                    <button type="button" class="custom-modal-close" aria-label="Close">
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.7071 1.70711L11.2929 0.292893L7 5.58579L2.70711 0.292893L1.29289 1.70711L5.58579 7L1.29289 12.2929L2.70711 13.7071L7 8.41421L11.2929 13.7071L12.7071 12.2929L8.41421 7L12.7071 1.70711Z" fill="#337AB7"></path>
                        </svg>
                    </button>
                </div>
                <div class="custom-modal-body">

                    <div id="editor2"></div>

                </div>
                <div class="custom-modal-footer">
                    <button type="button" id="closePolicyBtn" data-dismiss="modal" class="custom-modal-btn custom-modal-btn-secondary">Close</button>
                    <button type="button" id="updatePolicyBtn" data-dismiss="modal" class="custom-modal-btn custom-modal-btn-primary">Update</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-labelledby="uploadExcelModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #007bff; color: white;">
                    <h5 class="modal-title" id="uploadExcelModalLabel">Upload Excel File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Select Excel file</label>
                            <input class="form-control" type="file" id="fileInput" name="file" accept=".xlsx, .xls">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="uploadButton">Upload</button>
                </div>
            </div>
            <script src="/static/assets/js/excelUpload.js"></script>
        </div>
    </div>
    <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Success</h5>
                </div>
                <div class="modal-body">
                    <p>Data upload into the database successfully.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="changePasswordModal" class="modal fade" tabindex="-1">
        <link rel="stylesheet" type="text/css" th:href="@{/static/assets/css/modals.css}">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="currentPassword">Current Password:</label>
                        <div class="input-group">
                            <input type="password" id="currentPassword" name="currentPassword" required class="form-control">
                            <button id="checkPasswordBtn" class="btn btn-primary">Check</button>
                        </div>
                    </div>
                    <div id="changePasswordFields">
                        <div class="form-group">
                            <label for="changePassword">New Password:</label>
                            <input type="password" id="changePassword" name="changePassword" required class="form-control">
                            <div id="changePasswordMessage" class="text-danger" style="display: none">Your password is weak.</div>
                        </div>
                        <div class="form-group">
                            <label for="confirmChangePassword">Confirm Password:</label>
                            <input type="password" id="confirmChangePassword" name="confirmChangePassword" required class="form-control">
                            <div id="confirmChangePasswordMessage" class="text-danger" style="display: none">Passwords do not match.</div>
                        </div>
                        <div class="button-group">
                            <button id="restartBtn" class="btn btn-secondary">Restart</button>
                            <button id="saveBtn" class="btn btn-primary">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="/static/assets/js/changePassword.js" defer></script>
    <div class="modal fade" id="calendarModalBox" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel1">Calendar...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="calendar">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{index::footer}"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.2/emojionearea.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script th:inline="javascript">
    const authenticationName = /*[[${#authentication.name}]]*/ '';
</script>
<script >
    document.addEventListener("DOMContentLoaded",async function() {
        let quill;

        function createEditButton(policyId) {
            const editButton = document.createElement('button');
            editButton.classList.add('edit-button');
            editButton.setAttribute('data-policy-id', policyId);
            editButton.innerText = 'Edit';
            // Apply button style
            editButton.style.backgroundColor = '#007bff'; // Button color
            editButton.style.color = '#fff'; // Text color
            editButton.style.border = 'none';
            editButton.style.padding = '8px 16px';
            editButton.style.borderRadius = '4px';
            editButton.style.cursor = 'pointer';
            editButton.style.transition = 'background-color 0.3s';
            editButton.addEventListener('click', function() {
                console.log('Edit button clicked for policy ID: ' + policyId);
            });
            return editButton;
        }


        function createDeleteButton(policyId) {
            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-button');
            deleteButton.setAttribute('data-policy-id', policyId);
            deleteButton.innerText = 'Delete';
            // Apply button style
            deleteButton.style.backgroundColor = '#dc3545'; // Red button color
            deleteButton.style.color = '#fff'; // Text color
            deleteButton.style.border = 'none';
            deleteButton.style.padding = '8px 16px';
            deleteButton.style.borderRadius = '4px';
            deleteButton.style.cursor = 'pointer';
            deleteButton.style.transition = 'background-color 0.3s';
            deleteButton.addEventListener('click', function() {
                console.log('Delete button clicked for policy ID: ' + policyId);
            });
            return deleteButton;
        }
        fetch('/user/getAllPolicies')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const policyContainer = document.querySelector('.policy-container');
                console.log("reach policy")
                data.forEach(policy => {
                    console.log("policy reach1")
                    const policyElement = document.createElement('div');
                    policyElement.classList.add('policy');

                    const idParagraph = document.createElement('p');
                    idParagraph.hidden = true;
                    idParagraph.innerHTML = policy.id;
                    policyElement.appendChild(idParagraph);

                    const ruleParagraph = document.createElement('p');
                    ruleParagraph.innerHTML = policy.rule;
                    policyElement.appendChild(ruleParagraph);

                    if (policy.user.staffId === authenticationName) {
                        // Create and append edit button
                        const editButton = createEditButton(policy.id);
                        policyElement.appendChild(editButton);

                        // Create and append delete button
                        const deleteButton = createDeleteButton(policy.id);
                        policyElement.appendChild(deleteButton);
                    }

                    const writerParagraph = document.createElement('p');
                    writerParagraph.innerHTML = 'Writer: <span>' + policy.user.name + '</span>';
                    writerParagraph.style.fontSize = 'smaller';
                    policyElement.appendChild(writerParagraph);

                    const roleParagraph = document.createElement('p');
                    roleParagraph.innerHTML = 'Role: <span>' + policy.user.role + '</span>';
                    roleParagraph.style.fontSize='smaller';
                    policyElement.appendChild(roleParagraph);

                    const timeParagraph = document.createElement('p');
                    const formattedDate = new Date(policy.date);
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                    const formattedDateString = formattedDate.toLocaleDateString('en-GB', options);
                    timeParagraph.innerHTML = 'Time: <span>' + formattedDateString + '</span>';
                    timeParagraph.style.fontSize='smaller';
                    policyElement.appendChild(timeParagraph);

                    const hrElement = document.createElement('hr');
                    policyElement.appendChild(hrElement);

                    policyContainer.appendChild(policyElement);
                });

                document.querySelectorAll('.edit-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const policyId = this.getAttribute('data-policy-id');
                        fetch('/user/getOnePolicy?policyId=' + policyId)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                const editor = document.getElementById('editor2');
                                if (editor) {
                                    if (!quill) {
                                        quill = new Quill('#editor2', {
                                            theme: 'snow'
                                        });
                                    }
                                    quill.root.innerHTML = data.rule;
                                    document.getElementById('updatePolicyModal').style.display = 'block';
                                    document.getElementById('closePolicyBtn').addEventListener('click', function() {
                                        document.getElementById('updatePolicyModal').style.display = 'none';
                                    })
                                    // Update Policy
                                    document.getElementById('updatePolicyBtn').addEventListener('click', function() {
                                        data.rule = quill.root.innerHTML;
                                        fetch('/user/updatePolicy', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify(data)
                                        })
                                            .then(response => {
                                                if (!response.ok) {
                                                    throw new Error('Network response was not ok');
                                                }
                                                document.getElementById('updatePolicyModal').style.display = 'none';
                                                location.reload();
                                            })
                                            .catch(error => {
                                                console.error('There was a problem with the update operation:', error);
                                            });
                                    });

                                } else {
                                    console.error("Editor element not found");
                                }
                            })
                            .catch(error => {
                                console.error('There was a problem with the fetch operation:', error);
                            });
                    });
                });

                // Delete Policy
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const policyId = this.getAttribute('data-policy-id');
                        fetch('/user/deletePolicy/' + policyId, {
                            method: 'DELETE'
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }

                            })
                            .catch(error => {
                                console.error('There was a problem with the delete operation:', error);
                            });
                        location.reload();
                    });
                });

                // Close modal function
                document.querySelector('.custom-modal-close').addEventListener('click', function() {
                    document.getElementById('updatePolicyModal').style.display = 'none';
                });

                // Close modal on outside click
                window.addEventListener('click', function(event) {
                    if (event.target === document.getElementById('updatePolicyModal')) {
                        document.getElementById('updatePolicyModal').style.display = 'none';
                    }
                });

                // Prevent modal from closing when clicking inside the modal content
                document.querySelector('.custom-modal-content').addEventListener('click', function(event) {
                    event.stopPropagation();
                });

            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        await notifyMessage();
        const toggleCheckbox = document.getElementById("toggle-checkbox");
        const toggleKnob = document.getElementById("toggle-knob");
        const notiOnBell = document.getElementById('notiOnBell');
        const notiOffBell = document.getElementById('notiOffBell');
        const userStatus = await checkStatusForUser();
        if (userStatus.isOn === 'ON') {
            notiOnBell.style.display = 'block';
            notiOffBell.style.display = 'none';
            toggleCheckbox.checked = false;
        } else {
            notiOnBell.style.display = 'none';
            notiOffBell.style.display = 'block';
            toggleCheckbox.checked = true;
        }
        toggleCheckbox.addEventListener("change", async function() {
            if (toggleCheckbox.checked) {
                console.log("OFF");
                notiOnBell.style.display = 'none';
                notiOffBell.style.display = 'block';
                const data = await fetch(`/user/turn-off-noti`,{
                    method:'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body:JSON.stringify({ isOn: 'OFF' })
                });
                if(!data.ok){
                    console.log('something wrong please try again!');
                }
                const res = await data.text();
                let alertMessage = `${res}`;
                let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
                let styledAlert = document.createElement('div');
                styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
                styledAlert.innerHTML = alertMessage;


                document.body.appendChild(styledAlert);


                styledAlert.style.display = 'block';

                setTimeout(function () {
                    styledAlert.style.display = 'none';
                }, 3000);
            } else {
                console.log("ON");
                notiOnBell.style.display = 'block';
                notiOffBell.style.display = 'none';
                const data = await fetch(`/user/turn-on-noti`,{
                    method:'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body:JSON.stringify({ isOn: 'ON' })
                });
                if(!data.ok){
                    console.log('something wrong please try again!');
                }
                const res = await data.text();
                let alertMessage = `${res}`;
                let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
                let styledAlert = document.createElement('div');
                styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
                styledAlert.innerHTML = alertMessage;


                document.body.appendChild(styledAlert);


                styledAlert.style.display = 'block';

                setTimeout(function () {
                    styledAlert.style.display = 'none';
                }, 3000);
            }
        });
    });

    let notificationCount = 0;
    async function notifyMessage(){
        const showMessage = document.getElementById('notifyMessage');
        const pElement = document.createElement('p');
        pElement.classList.add('noti-p-element');
        if (notificationCount === 0) {
            pElement.style.display = 'block';
            pElement.textContent = 'There is no notification yet!';
        } else {
            pElement.style.display = 'none';
            pElement.textContent = '';
        }
        showMessage.appendChild(pElement);
    };

    let currentPageForEach = '0';
    let isFetchingForEach = false;
    let hasMoreForEach = true;

    async function fetchNotificationPerPage(){
        isFetchingForEach = true;
        let response = await fetch(`/user/get-all-noti/${currentPageForEach}`, {
            method: 'GET'
        });
        let root = document.getElementById('root');
        root.innerHTML = '';

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        let data = await response.json();
        isFetchingForEach = false;
        if (data.length === 0) {
            hasMoreForEach = false;
            return;
        }
        for (let noti of data) {
            let divElement = document.createElement('div');
            divElement.classList.add('notificationForNoti', `postId-${noti.postId}`);
            divElement.id = `noti-deleted-${noti.id}`;
            divElement.dataset.postId = noti.postId;
            divElement.style.borderRadius = '10px';
            divElement.style.width = '380px';
            attachNotificationEventListenersForEach();
            console.log("GetIDFORMEnto",noti.mentionId)
            const trashIcon = document.createElement('i');
            trashIcon.id = `trashIcon-deleted-${noti.id}`
            trashIcon.classList.add('fa-solid','fa-trash-can');
            trashIcon.style.marginLeft = '400px';
            trashIcon.addEventListener('click',async () => {
                const notiID = noti.id;
                await deletedNotificationForEach(notiID);
            });
            const spEle = document.createElement('span');
            spEle.style.marginTop = '-40px';
            spEle.appendChild(trashIcon);
            if (noti.reactId && !noti.commentId && !noti.replyId) {
                const reactType = await fetchReactTypeForNotificationForEach(noti.reactId);
                console.log('React Type user', reactType.user.staffId)
                const user = await fetchUserDataByPostedUserForEach(reactType.user.staffId);
                const photo = user.photo || '/static/assets/img/default-logo.png';
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';
                const pElement = document.createElement('p');
                let imgReactElement = document.createElement('img');
                if (reactType.type) {
                    imgReactElement.src = `/static/assets/img/${reactType.type.toLowerCase()}.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + `${noti.content}`;
                } else {
                    imgReactElement.src = `/static/assets/img/cancel.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + ` canceled reaction in your post`;
                }
                divElement.appendChild(imgElement);
                divElement.appendChild(imgReactElement);
                divElement.appendChild(pElement);
            }

            if (noti.commentId && !noti.replyId && !noti.reactId) {
                const commentUser = await fetchCommetedUserForEach(noti.commentId);
                console.log('Comment user', commentUser.user.name)
                const photo = commentUser.user.photo || '/static/assets/img/default-logo.png';
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';

                const pElement = document.createElement('p');
                pElement.style.display = 'inline-block';
                pElement.style.marginLeft = '10px'; // Adjust margin as needed
                pElement.innerHTML = `${commentUser.user.name} commented to your post`;

                divElement.appendChild(imgElement);
                divElement.appendChild(pElement);
            }

            if (noti.commentId && noti.replyId && !noti.reactId) {
                const replyUser = await fetchRepliedUserForDataForEach(noti.replyId);
                console.log('photo', replyUser.user.photo);
                console.log('photo', replyUser.user.staffId);
                const photo = replyUser.user.photo ||  '/static/assets/img/default-logo.png';
                console.log('Reply user', replyUser.user.name);
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';

                const pElement = document.createElement('p');
                pElement.style.display = 'inline-block';
                pElement.style.marginLeft = '10px'; // Adjust margin as needed
                pElement.innerHTML = `${replyUser.user.name} replied to your comment`;

                divElement.appendChild(imgElement);
                divElement.appendChild(pElement);
            }


            if (noti.reactId && noti.commentId && !noti.replyId) {
                const reactType = await fetchReactTypeForNotificationForEach(noti.reactId);
                console.log('React Type user', reactType.user.staffId)
                const user = await fetchUserDataByPostedUserForEach(reactType.user.staffId);
                const photo = user.photo ||  '/static/assets/img/default-logo.png';
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';
                const pElement = document.createElement('p');
                let imgReactElement = document.createElement('img');
                if (reactType.type) {
                    imgReactElement.src = `/static/assets/img/${reactType.type.toLowerCase()}.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + `${reactType.type}` + ' your comment';
                } else {
                    imgReactElement.src = `/static/assets/img/cancel.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + ` canceled reaction in` + ' your comment';
                }
                divElement.appendChild(imgElement);
                divElement.appendChild(imgReactElement);
                divElement.appendChild(pElement);
            }

            if (noti.reactId && !noti.commentId && noti.replyId) {
                const reactType = await fetchReactTypeForNotificationForEach(noti.reactId);
                console.log('React Type user', reactType.user.staffId)
                const user = await fetchUserDataByPostedUserForEach(reactType.user.staffId);
                const photo = user.photo ||  '/static/assets/img/default-logo.png';
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';
                const pElement = document.createElement('p');
                let imgReactElement = document.createElement('img');
                if (reactType.type) {
                    imgReactElement.src = `/static/assets/img/${reactType.type.toLowerCase()}.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + `${reactType.type}` + ' your reply';
                } else {
                    imgReactElement.src = `/static/assets/img/cancel.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + ` canceled reaction in ` + ' your reply';
                }
                divElement.appendChild(imgElement);
                divElement.appendChild(imgReactElement);
                divElement.appendChild(pElement);
            }

            if (noti.mentionId) {
                const mention = await getMentionByIdForEach(noti.mentionId);
                console.log("SDFDSF555"+mention.postedUserId)
                console.log("SDFDSF555"+mention.post.id)
                if(!mention.comment) {
                    const getUser = await getMentionUserForEach(mention.postedUserId);
                    const photo = getUser.photo || '/static/assets/img/default-logo.png';
                    console.log("MenitonUSer", getUser.name)
                    let imgElement = document.createElement('img');
                    imgElement.src = `${photo}`;
                    imgElement.width = 40;
                    imgElement.height = 40;
                    imgElement.style.borderRadius = '50%';

                    const pElement = document.createElement('p');
                    pElement.style.display = 'inline-block';
                    pElement.style.marginLeft = '10px'; // Adjust margin as needed
                    pElement.innerHTML = `${getUser.name} mentioned you in a post`;

                    divElement.appendChild(imgElement);
                    divElement.appendChild(pElement);
                }else{
                    const getUser = await getMentionUserForEach(mention.postedUserId);
                    const photo = getUser.photo ||  '/static/assets/img/default-logo.png';
                    console.log("MenitonUSer", getUser.name)
                    let imgElement = document.createElement('img');
                    imgElement.src = `${photo}`;
                    imgElement.width = 40;
                    imgElement.height = 40;
                    imgElement.style.borderRadius = '50%';

                    const pElement = document.createElement('p');
                    pElement.style.display = 'inline-block';
                    pElement.style.marginLeft = '10px'; // Adjust margin as needed
                    pElement.innerHTML = `${getUser.name} mentioned you in a comment`;

                    divElement.appendChild(imgElement);
                    divElement.appendChild(pElement);
                }
            }
            const container =  document.createElement('div');
            container.classList.add('container-trash-div')
            container.style.display = 'inline-grid';
            container.appendChild(divElement);
            container.appendChild(spEle);
            root.appendChild(container);
        }
    };

    async function fetchReactTypeForNotificationForEach(id){
        const reactType = await fetch(`/user/like-noti-type/${id}`);
        const reactDataType = await reactType.json();
        return reactDataType;
    }

    async function fetchUserDataByPostedUserForEach(id){
        const fetchUserData = await fetch(`/get-userData/${id}`);
        if (!fetchUserData.ok) {
            alert('Invalid user');
        }
        const userDataForAll = await fetchUserData.json();
        return userDataForAll;
    };

    async function fetchCommetedUserForEach(id){
        const commentUser = await fetch(`/user/comment-user-data/${id}`);
        if (!commentUser.ok) {
            alert('something wrong');
        }
        const commentUserData = await commentUser.json();
        return commentUserData;
    }

    async function fetchRepliedUserForDataForEach(id){
        const fetchDataForUser = await fetch(`/user/reply-user-data/${id}`);
        const userDataForReply = await fetchDataForUser.json();
        return userDataForReply;
    };

    async function getMentionUserForEach(id){
        const data = await fetch(`/getData-mention/${id}`);
        const res = await data.json();
        return res;
    }

    async function getMentionByIdForEach(id){
        const data = await fetch(`/get-mentionUser/${id}`);
        const res = await data.json();
        return res;
    }

    async function deletedNotificationForEach(id){
        const deleteNoti = await fetch(`/delete-noti/${id}`,{
            method:'DELETE'
        });
        if(!deleteNoti.ok){
            alert('something wrong please try again later');
        }else {
            const divElement = document.getElementById(`noti-deleted-${id}`);
            const trashIconEl = document.getElementById(`trashIcon-deleted-${id}`);
            if (divElement && trashIconEl ) {
                console.log("it's fine",id)
                divElement.remove();
                trashIconEl.remove();
            }
        }
    }

    function attachNotificationEventListenersForEach(){
        const notificationElements = document.querySelectorAll('.notificationForNoti');
        notificationElements.forEach(notificationElement => {
            notificationElement.addEventListener('click', async function() {
                console.log("Clicked on notification element");
                const postId = this.dataset.postId; // 'this' refers to the current notification element
                console.log('PostId', postId);
                const postElement = document.getElementById(postId);
                const pElement = this.querySelector('p');
                if (postElement) {
                    postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }else{
                    if (pElement) {
                        localStorage.setItem('commentOrReply',pElement.textContent);
                    }
                    localStorage.setItem('trendPostIdForSinglePost',postId);
                    window.location.href = `/user-details-post`;
                }
            });
        });
    };

    document.addEventListener('DOMContentLoaded', async () => {
        // await fetchNotificationPerPage();
        const modalContent = document.getElementById('content-notification');
        modalContent.addEventListener('scroll', async () => {
            if (isFetchingForEach || !hasMoreForEach) {
                console.log('currentPage', currentPageForEach);
                return;
            }

            if (modalContent.scrollTop + modalContent.clientHeight >= modalContent.scrollHeight) {
                currentPageForEach++;
                console.log('currentPage', currentPageForEach);
                await fetchNotificationPerPage();
            }
        });
    });

    //for invitation start

    async function showInvitation(){
        const showCount = document.getElementById('inviteMessageCount');
        const size = await getInvitation();
        console.log('adfdfdfdfdf',size)
        if(size === 0){
            showCount.innerText = ''
        }else{
            showCount.innerText = size;
        }
    }

    async function getInvitedUserById(id){
        const data = await fetch(`/user/get-invited-user/${id}`);
        const res = await data.json();
        return res;
    }

    document.addEventListener('DOMContentLoaded',async function () {
       await showInvitation();
         await showEmptyContent();
        await getInvitation();
        await getAllInvitations();
    });

    async function getInvitation(){
        const msgCount = await fetch('/user/invited-user-count');
        const msgSize = await msgCount.json();
        return msgSize;
    }

    async function showEmptyContent(){
        const invitations = await fetchInvitationMessage();
        const root = document.getElementById('messageRoot');
        if(invitations.length === 0){
            root.style.fontSize = '30px';
            root.innerHTML = 'There is no invitations yet...';
        }
    }


    async function getAllInvitations(){
        const invitation = await fetchInvitationMessage();
        for (const i of invitation) {
            await displayMessageForInvitation(i.id,i.community.image,i.community.name,i.community.id,i.senderId);
        }
    }

    async function displayMessageForInvitation(id,image,name,communityId,userId){
        const root = document.getElementById('messageRoot');
        const divElement = document.createElement('div');
        divElement.classList.add(`invitation-message-${id}`)
        divElement.style.padding = '15px';
        divElement.style.border = '1px solid black';
        divElement.style.borderRadius = '10px';
        divElement.style.margin = '3px';
        divElement.style.marginLeft = '55px';
        divElement.style.marginTop = '-35px';
        divElement.style.borderBottomLeftRadius = '40px';
        divElement.style.backgroundColor = 'lightgrey';
        const invitedUser = await getInvitedUserById(userId);
        const spElementForImage = document.createElement('span');
        spElementForImage.classList.add(`span-image-${id}`);
        const imgTag = document.createElement('img');
        const photo = `${image}`|| `/static/assets/img/default-logo.png`;
        imgTag.src = photo;
        imgTag.style.width = '50px';
        imgTag.style.height = '50px';
        imgTag.style.borderRadius = '50%';
        spElementForImage.appendChild(imgTag);
        const spElementForContent = document.createElement('span');
        spElementForContent.innerHTML = `${invitedUser.name} (${invitedUser.dept}) invited you to join ${name} group`;
        const buttonsWrapper = document.createElement('div');
        buttonsWrapper.classList.add(`button-wrapper-${id}`)
        buttonsWrapper.style.marginLeft = '220px';
        const acceptButton = document.createElement('button');
        acceptButton.innerHTML = 'Accept'
        acceptButton.classList.add('btn','btn-outline-success')
        acceptButton.id = id;
        acceptButton.addEventListener('click',async () => {
            await acceptInvitation(id,communityId,name);
        });
        const denyButton = document.createElement('button');
        denyButton.innerHTML = 'Reject';
        denyButton.classList.add('btn','btn-outline-danger')
        denyButton.addEventListener('click', async () => {
            await rejectInvitation(id);
        });
        buttonsWrapper.appendChild(acceptButton);
        buttonsWrapper.appendChild(denyButton);
        divElement.appendChild(spElementForContent);
        // divElement.appendChild(buttonsWrapper);
        const allWrapDiv = document.createElement('div');
        allWrapDiv.classList.add(`all-wrap-div-${id}`);
        allWrapDiv.appendChild(spElementForImage)
        allWrapDiv.appendChild(divElement);
        allWrapDiv.appendChild(buttonsWrapper);
        root.appendChild(allWrapDiv);
    }


    async function acceptInvitation(id,communityId,name){
        const data = await fetch(`/user/accept-invitation/${id}/${communityId}`);
        const response = await data.json();
        if(response){
            const divEl = document.querySelector(`.all-wrap-div-${id}`);
            if(divEl){
                await showInvitation();
                divEl.remove();
            }
            let alertMessage = response.message + ` ${name}`;
            let alertStyle = `
            background-color: white;
            color: blue;
            border: 1px solid #cc0000;
            border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function() {
                styledAlert.style.display = 'none';
            }, 5000);
        }
    }


    async function rejectInvitation(id){
        const data = await fetch(`/user/reject-invitation/${id}`);
        const response = await data.json();
        if(response){
            const divEl = document.querySelector(`.all-wrap-div-${id}`);
            if(divEl){
                await showInvitation();
                divEl.remove();

            }
            let alertMessage = response.message;
            let alertStyle = `
            background-color: #ffcccc;
            color: #cc0000;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function() {
                styledAlert.style.display = 'none';
            }, 3000);
        }
    }

    async function fetchInvitationMessage(){
        const data = await fetch('/user/invited-user-display');
        const response = await data.json();
        return response;
    }

    async function checkStatusForUser(){
        const data = await fetch(`/user/check-notiStatus`);
        const res = await data.json();
        return res;
    }
    //for invitation end
</script>
</body>
</html>