<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{index::head}">
    <title>Create Community</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div th:replace="~{index::header}"></div>
<div th:replace="~{index::navbar}"></div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<main id="main" class="main">
    <div class="container mt-5" style="background: transparent">
        <span id="message"></span>
        <button type="button" class="btn btn-primary" id="changeInactiveGroup" sec:authorize="hasAnyAuthority('ADMIN')">
            <i class="fa-solid fa-arrow-rotate-right"></i> Active Group
        </button>

        <!-- Create Community Modal -->
    </div>
    <div class="container">
        <link rel="stylesheet" href="/assets/css/group-card.css">
        <div id="communityCards"></div>
        <div id="inactiveCommunityCards" style="display: none;"></div>
    </div>
    <button style="background-color: transparent;border-radius: 50px;border: 1px solid dodgerblue" id="App"
            class="createIcon offset-10 m-1" data-toggle="modal" data-target="#createCommunityModal"
            sec:authorize="hasAnyAuthority('ADMIN')">
        <i class="fa-solid fa-user-pen"></i>
    </button>
    <!-- Add Community Modal -->
    <div class="container">
        <div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createCommunityModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background-color: #007bff">
                        <h5 class="modal-title" id="createGroupModalLabel" style="color: white">Add User in
                            Community</h5>
                    </div>
                    <div class="modal-body">
                        <form id="createGroupForm">
                            <div class="form-group">
                                <label for="name1">Name:</label>
                                <input type="text" class="form-control" id="name1" name="name">
                            </div>
                            <br>
                            <input type="hidden" id="communityId1" name="id">
                            <div class="row mb-4">
                                <label>Choose Member's List:</label><br>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="userSearch" placeholder="Search users.."
                                           style="margin-left: 329px">
                                    <div id="usersList"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="description1">Description:</label>
                                <input type="text" class="form-control" id="description1" name="description">
                            </div>
                            <br>
                            <div class="form-group">
                                <label for="image1">Image:</label>
                                <input type="file" class="form-control" accept="image/**" id="image1" name="file"
                                       style="border-right: 15px;" multiple="multiple"/>
                            </div>
                            <span id="photo"></span>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                id="createGroupModalCloseBtn">Close
                        </button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" id="createGroupBtn">Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Kick Community Modal -->
    <div class="container">
        <div class="modal fade" id="kickModal" tabindex="-1" aria-labelledby="createCommunityModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <form id="kickForm">
                            <div class="row mb-4">
                                <label style="font-weight: bold;font-family: bootstrap-icons;font-size: 20px">Member's
                                    List:</label><br>
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="userSearchForKick"
                                           placeholder="Search users.." style="margin-left: 329px">
                                    <div id="userList"></div>
                                </div>
                            </div>
                            <input type="hidden" id="communityId" name="id">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="kickModalCloseBtn">
                            Close
                        </button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" id="kickGroupBtn">Kick
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-labelledby="uploadExcelModalLabel"
         aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #007bff; color: white;">
                    <h5 class="modal-title" id="uploadExcelModalLabel">Upload Excel File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Select Excel file</label>
                            <input class="form-control" type="file" id="fileInput" name="file" accept=".xlsx, .xls">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="uploadButton">Upload
                    </button>
                </div>
            </div>
            <script src="/static/assets/js/excelUpload.js"></script>
        </div>
    </div>
    <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Success</h5>
                </div>
                <div class="modal-body">
                    <p>Data upload into the database successfully.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div id="changePasswordModal" class="modal fade" tabindex="-1">
        <link rel="stylesheet" type="text/css" th:href="@{/static/assets/css/modals.css}">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="currentPassword">Current Password:</label>
                        <div class="input-group">
                            <input type="password" id="currentPassword" name="currentPassword" required
                                   class="form-control">
                            <button id="checkPasswordBtn" class="btn btn-primary">Check</button>
                        </div>
                    </div>
                    <div id="changePasswordFields">
                        <div class="form-group">
                            <label for="changePassword">New Password:</label>
                            <input type="password" id="changePassword" name="changePassword" required
                                   class="form-control">
                            <div id="changePasswordMessage" class="text-danger" style="display: none">Your password is
                                weak.
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirmChangePassword">Confirm Password:</label>
                            <input type="password" id="confirmChangePassword" name="confirmChangePassword" required
                                   class="form-control">
                            <div id="confirmChangePasswordMessage" class="text-danger" style="display: none">Passwords
                                do not match.
                            </div>
                        </div>
                        <div class="button-group">
                            <button id="restartBtn" class="btn btn-secondary">Restart</button>
                            <button id="saveBtn" class="btn btn-primary">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="/static/assets/js/changePassword.js" defer></script>
    <div class="modal fade" id="calendarModalBox" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel1">Calendar...</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="calendar">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</main>


<div class="modal fade" id="staticBackdropForChangeAccess" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #007bff">
                <h5 class="modal-title" id="staticBackdropLabelForChangeAccess" style="color: white">Change Access:</h5>
            </div>
            <div class="modal-body">
                <input type="hidden" id="groupId" name="communityId">
                <input type="hidden" id="changeAccess" name="groupAccess">
                <div id="changeAccessWords"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"
                        id="changeAccessCloseBtn">Close
                </button>
                <button type="button" class="btn btn-outline-success" id="changeAccessSubmitBtn">Change</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="staticBackdropForRebuildGroup" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #007bff">
                <h5 class="modal-title" id="staticBackdropLabelForRebuildGroup" style="color: white"><i class="fa-solid fa-recycle"></i>Reusable
                    group:</h5>
            </div>
            <div class="modal-body">
                <input type="hidden" id="groupIdForRebuild" name="communityId">
                <div id="RebuildGroupWords"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"
                        id="rebuildGroupCloseBtn">Close
                </button>
                <button type="button" class="btn btn-outline-success" id="rebuildGroupSubmitBtn">Change</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="staticBackdropForLeaveGroup" data-bs-backdrop="static" data-bs-keyboard="false"
     tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #007bff">
                <h5 class="modal-title" id="staticBackdropLabelForLeaveGroup" style="color: white"><i class="fa-solid fa-person-walking-arrow-right"></i>Leave the group:</h5>
            </div>
            <div class="modal-body">
                <input type="hidden" id="groupIdForLeave" name="communityId">
                <div id="leaveGroupWords"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="leaveGroupCloseBtn">
                    Close
                </button>
                <button type="button" class="btn btn-outline-success" id="leaveGroupSubmitBtn">Change</button>
            </div>
        </div>
    </div>
</div>
<!-- Button trigger modal -->

<!-- Delete Community Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Delete Group</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this group?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="confimationModelCloseBtn">
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDelete" onclick="deleteConfirmed()">Delete
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createCommunityModal" tabindex="-1" aria-labelledby="createCommunityModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #007bff">
                <h5 class="modal-title" id="createCommunityModalLabel" style="color:white;">Create
                    Community</h5>
            </div>
            <div class="modal-body">
                <form id="createCommunityForm">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" class="form-control" id="name" name="name">
                        <span id="nameError" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label for="ownerId">Choose Owner Name:</label>
                        <input type="text" class="form-control" id="userSearchForAdd" placeholder="Search users.." style="margin-left: 329px;width:150px;"><br>
                        <select class="form-select" id="ownerId" name="ownerId">
                            <option value="">Select Owner</option>
                            <option th:each="user : ${users}" th:value="${user.id}"
                                    th:text="${user.name}"></option>
                        </select>
                        <span id="ownerIdError" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <input type="text" class="form-control" id="description" name="description">
                        <span id="descriptionError" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label for="description">Access:<i class="fa-solid fa-lock"></i></label>
                        <select name="groupAccess" id="groupAccessForCommunity" class="form-select">
                            <option value="PUBLIC" selected>PUBLIC</option>
                            <option value="PRIVATE">PRIVATE</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="file">Image:</label>
                        <input type="file" class="form-control" accept="image/**" id="file" name="file"
                               multiple="multiple"/>
                        <span id="fileError" class="text-danger"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="createCommunityBtn">Create</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="staticBackdropForAddOwner" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabelAddOwner"><i class="fa-solid fa-user-tie"></i>Choose a
                    group admin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" class="form-control" id="idForCommunity">
                <input type="text" placeholder="search..." class="form-control" id="searchForAddGroupOwner"
                       style="width: 150px;margin: 10px 10px 10px 315px;">
                <select name="status" id="statusForAddOwner" class="form-select">

                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="addOwnerCloseBtn">Close
                </button>
                <button type="button" class="btn btn-primary" id="addOwnerSubmitBtn">Add</button>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{index::footer}"></div>
<!--<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
<script src="https://kit.fontawesome.com/e2397b357b.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script>


    async function goToCommunityDetail(id) {
        localStorage.setItem('communityIdForDetailPage', id)
        window.location.href = '/api/community/goToCommunityDetail'
    }

    document.getElementById('createCommunityBtn').addEventListener('click', async (e) => {
        e.preventDefault();

        const name = document.getElementById('name').value;
        const ownerId = document.getElementById('ownerId').value;
        const description = document.getElementById('description').value;
        const file = document.getElementById('file').value;
        let isValid = true;
        if (name.trim() === '') {
            document.getElementById('nameError').innerHTML = 'Name cannot be empty!';
            isValid = false;
        } else {
            document.getElementById('nameError').innerHTML = '';
        }

        if (ownerId.trim() === '') {
            document.getElementById('ownerIdError').innerHTML = 'Please select a owner!';
            isValid = false;
        } else {
            document.getElementById('ownerIdError').innerHTML = '';
        }

        if (description.trim() === '') {
            document.getElementById('descriptionError').innerHTML = 'Please fill the description out!';
            isValid = false;
        } else {
            document.getElementById('descriptionError').innerHTML = '';
        }


        if (!isValid) {
            e.preventDefault();
        } else {
            await insertGroup();
        }

    });
    const insertGroup = async () => {
        const formData = new FormData(document.getElementById('createCommunityForm'));
        const url = "/api/community/createCommunity";
        const data = await fetch(url, {
            method: 'POST',
            body: formData
        });
        if (data.ok) {
            const result = await data.json();
            await fetchCommunities();
            const messageElement = document.getElementById('message');
            document.getElementById('createCommunityForm').reset();
            let alertMessage = result.message;
            let alertStyle = `
            background-color: blue;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);

            $('#createCommunityModal').modal('hide');
            styledAlert.style.display = 'block';
            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
        } else {
            const content = 'Error creating community';

            let alertMessage = content;
            let alertStyle = `
            background-color: red;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
        }
    }
    document.addEventListener("DOMContentLoaded",async function () {
        await fetchCommunities();
        const loginUser = await getCurrentUser();
        if(loginUser.role === 'ADMIN'){
            await  toggleForStatus();
        }
            const userSearch = document.getElementById('userSearchForAdd');
            const usersList = document.getElementById('ownerId');
            const allUsers = Array.from(usersList.querySelectorAll('option')).map(option => ({
                value: option.value,
                text: option.textContent
            }));

            userSearch.addEventListener('input', function() {
                const searchValue = this.value.toLowerCase();

                usersList.innerHTML = '';

                let foundMatch = false;
                allUsers.forEach(user => {
                    if (user.text.toLowerCase().includes(searchValue)) {
                        const option = document.createElement('option');
                        option.value = user.value;
                        option.text = user.text;
                        usersList.appendChild(option);
                        foundMatch = true;
                    }
                });

                if (!foundMatch && searchValue !== '') {
                    const option = document.createElement('option');
                    option.value = '';
                    option.text = 'No users found';
                    usersList.appendChild(option);
                }
            });
           await notifyMessage();
        const toggleCheckbox = document.getElementById("toggle-checkbox");
        const toggleKnob = document.getElementById("toggle-knob");
        const notiOnBell = document.getElementById('notiOnBell');
        const notiOffBell = document.getElementById('notiOffBell');
        const userStatus = await checkStatusForUser();
        if (userStatus.isOn === 'ON') {
            notiOnBell.style.display = 'block';
            notiOffBell.style.display = 'none';
            toggleCheckbox.checked = false;
        } else {
            notiOnBell.style.display = 'none';
            notiOffBell.style.display = 'block';
            toggleCheckbox.checked = true;
        }
        toggleCheckbox.addEventListener("change", async function() {
            if (toggleCheckbox.checked) {
                console.log("OFF");
                notiOnBell.style.display = 'none';
                notiOffBell.style.display = 'block';
                const data = await fetch(`/user/turn-off-noti`,{
                    method:'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body:JSON.stringify({ isOn: 'OFF' })
                });
                if(!data.ok){
                    console.log('something wrong please try again!');
                }
                const res = await data.text();
                let alertMessage = `${res}`;
                let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
                let styledAlert = document.createElement('div');
                styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
                styledAlert.innerHTML = alertMessage;


                document.body.appendChild(styledAlert);


                styledAlert.style.display = 'block';

                setTimeout(function () {
                    styledAlert.style.display = 'none';
                }, 3000);
            } else {
                console.log("ON");
                notiOnBell.style.display = 'block';
                notiOffBell.style.display = 'none';
                const data = await fetch(`/user/turn-on-noti`,{
                    method:'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body:JSON.stringify({ isOn: 'ON' })
                });
                if(!data.ok){
                    console.log('something wrong please try again!');
                }
                const res = await data.text();
                let alertMessage = `${res}`;
                let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
                let styledAlert = document.createElement('div');
                styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
                styledAlert.innerHTML = alertMessage;


                document.body.appendChild(styledAlert);


                styledAlert.style.display = 'block';

                setTimeout(function () {
                    styledAlert.style.display = 'none';
                }, 3000);
            }
        });
        });

    async function fetchCommunities() {
        try {
            const response = await fetch('/api/community/communityview');
            const data = await response.json();
            await populateCommunityCards(data, 'communityCards');
        } catch (error) {
            console.error('Error fetching communities:', error);
        }
    }

    async function fetchInactiveCommunities() {
        try {
            const response = await fetch('/api/community/inactive-community-view');
            if (!response.ok) {
                alert('Something went wrong, please try again!');
            } else {
                const data = await response.json();
                await populateCommunityCards(data, 'inactiveCommunityCards');
            }
        } catch (error) {
            console.error('Error fetching inactive communities:', error);
        }
    }

    let notificationCount = 0;
    async function notifyMessage(){
        const showMessage = document.getElementById('notifyMessage');
        const pElement = document.createElement('p');
        pElement.classList.add('noti-p-element');
        if (notificationCount === 0) {
            pElement.style.display = 'block';
            pElement.textContent = 'There is no notification yet!';
        } else {
            pElement.style.display = 'none';
            pElement.textContent = '';
        }
        showMessage.appendChild(pElement);
    };

  const toggleForStatus = async () => {
      let showActive = true;

      document.getElementById('changeInactiveGroup').addEventListener('click', async () => {
          if (showActive) {
              await fetchInactiveCommunities();
              document.getElementById('inactiveCommunityCards').style.display = 'block';
              document.getElementById('communityCards').style.display = 'none';
              document.getElementById('changeInactiveGroup').innerHTML = `
            <i class="fa-solid fa-arrow-rotate-left"></i>  Inactive Group
        `;
          } else {
              await fetchCommunities();
              document.getElementById('inactiveCommunityCards').style.display = 'none';
              document.getElementById('communityCards').style.display = 'block';
              document.getElementById('changeInactiveGroup').innerHTML = `
            <i class="fa-solid fa-arrow-rotate-right"></i>  Active Group`;
          }
          showActive = !showActive;
      });
  }

    async function fetchOwnerNames(communityId) {
        const response = await fetch(`/api/community/ownerNames/${communityId}`);
        const data = await response.json();
        return data;
    }

    async function populateCommunityCards(communities, containerId) {
        const communityCardsContainer = document.getElementById(containerId);
        let cardsHtml = '';
        const currentUser = await getCurrentUser();

        for (let i = 0; i < communities.length; i++) {
            const community = communities[i];
            let photo = '';
            if (community.image) {
                photo = `<img src="${community.image}" class="image" alt="Group's Photo" width="100" height="100">`;
            }
            let lockButton = document.createElement('i');
            if (community.groupAccess === 'PUBLIC') {
                lockButton.classList.add('fa-solid', 'fa-lock-open');
            } else {
                lockButton.classList.add('fa-solid', 'fa-lock');
            }
            let groupIcon = document.createElement('i');
            groupIcon.classList.add('fa-solid', 'fa-people-group');
            const isActive = community.active;
            console.log("ISAVTIBE", isActive)
            const lockButtonHtml = lockButton.outerHTML;
            const groupIconButton = groupIcon.outerHTML;
            const isAnonymous = community.ownerName === 'ANONYMOUS';
            const ownerNames = await fetchOwnerNames(community.id);
            const isNotCurrentUserOwner = currentUser.name !== community.ownerName && currentUser.role === 'USER';
            const isNotAdmin = currentUser.role !== 'ADMIN';
            const memberNames = ownerNames.length > 1 ? ownerNames.slice(1, 4).join(', ') : '';
            const moreMembersCount = ownerNames.length - 3;
            const moreMembersText = moreMembersCount > 0 ? `+${moreMembersCount} more` : '';

            cardsHtml += `
                    <div class="card community-card">
                        ${photo}
                        <div class="card-body">
                            <h5 class="card-title">${community.name}</h5>
                            <p class="card-text">${community.description}</p>
                            <p class="card-text">Owner: ${community.ownerName}</p>
                            <div class="member-list">
                                <span class="member-name">${memberNames}</span>
                                ${moreMembersText ? `<span class="member-name">${moreMembersText}</span>` : ''}
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    ...
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <a class="dropdown-item" style="cursor: pointer" ${!isActive ? 'hidden' : ''} onclick="goToCommunityDetail(${community.id})">View Detail</a>
                                    <a class="dropdown-item" style="cursor: pointer" href="#" ${isNotCurrentUserOwner || !isActive ? 'hidden' : ''} onclick="populateKickGroupForm(${community.id})">Kick a Member</a>
                                    <a class="dropdown-item" style="cursor: pointer" href="#" ${isNotAdmin || !isActive ? 'hidden' : ''} onclick="showConfirmationModal(${community.id})">Delete the Group</a>
                                    <a class="dropdown-item" style="cursor: pointer" href="#" ${isAnonymous && !isNotAdmin && isActive ? '' : 'hidden'} onclick="showAddGroupOwner(${community.id})">Add Group Admin</a>
                                    <a class="dropdown-item" style="cursor: pointer" href="#" ${isNotCurrentUserOwner || !isActive ? 'hidden' : ''} onclick="changeStatusForGroup('${community.id}','${community.groupAccess}')">${lockButtonHtml}Change Access</a>
                                    <a class="dropdown-item" style="cursor: pointer" href="#" ${isActive ? 'hidden' : ''} onclick="changeIsActiveForGroup('${community.id}')">${groupIconButton}Rebuild</a>
                                    <a class="dropdown-item" style="cursor: pointer" href="#" ${!isNotCurrentUserOwner ? 'hidden' : ''}  onclick="leaveGroup('${community.id}')">Leave the group</a>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary chat-button" ${!isActive ? 'hidden' : ''} onclick="goToChatRoom(${community.id})"></button>
                            <button type="button" class="btn btn-success add-button" ${isNotCurrentUserOwner || !isActive ? 'hidden' : ''} onclick="populateCreateGroupForm(${community.id}, '${community.name}', '${community.ownerName}', '${community.description}', '${community.image}')"><i class="fa fa-factory"></i></button>
                        </div>
                    </div>
                `;
        }

        communityCardsContainer.innerHTML = cardsHtml;
    }

    const getAllUsers = async () => {
        const url = '/api/community/users';
        const data = await fetch(url);
        if (data.ok) {
            const dataResponse = await data.json();
            console.log('all users', dataResponse);
            return dataResponse;
        }
    };

    const getUserListWithoutAdmin = async () => {
        const data = await fetch(`/api/community/getActiveUsersForAdd`);
        const res = await data.json();
        return res;
    }

    const showAddGroupOwner = async (id) => {
        const users = await getUserListWithoutAdmin();
        const selectElement = document.getElementById('statusForAddOwner');
        const searchInput = document.getElementById('searchForAddGroupOwner');
        document.getElementById('idForCommunity').value = id;

        const populateSelect = (users) => {
            selectElement.innerHTML = '';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.text = user.name;
                selectElement.add(option);
            });
        };
        populateSelect(users);
        searchInput.addEventListener('input', () => {
            const searchQuery = searchInput.value.toLowerCase();
            const filteredUsers = users.filter(user => user.name.toLowerCase().includes(searchQuery));
            populateSelect(filteredUsers);
        });

        $('#staticBackdropForAddOwner').modal('show');
    }

    document.getElementById('addOwnerSubmitBtn').addEventListener('click', async () => {
        const communityValue = document.getElementById('idForCommunity').value;
        const selectedUser = document.getElementById('statusForAddOwner').value;
        const myObj = {
            communityId: communityValue,
            userId: selectedUser
        }

        const data = await fetch(`/api/community/add-groupAdmin`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(myObj)
        });
        if (!data.ok) {
            alert("something wrong please try again!");
        } else {
            const res = await data.json();
            let alertMessage = `${res.message}`;
            let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
            await fetchCommunities();
            $('#staticBackdropForAddOwner').modal('hide');
        }
    });

    async function leaveGroup(id) {
        document.getElementById('groupIdForLeave').value = id;
        const pElement = document.getElementById('leaveGroupWords');
        pElement.style.fontSize = '20px';
        pElement.style.fontWeight = 'bold';
        pElement.innerHTML = `Are you sure want to leave from group ...`;
        $('#staticBackdropForLeaveGroup').modal('show');
    }

    document.getElementById('leaveGroupSubmitBtn').addEventListener('click', async () => {
        const id = document.getElementById('groupIdForLeave').value;
        console.log('CLICKED');
        const data = await fetch(`/api/community/leave-group/${id}`, {
            method: 'POST'
        });
        if (!data.ok) {
            alert('Something wrong please try again!');
        } else {
            const res = await data.json();
            let alertMessage = `${res.message}`;
            let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;
            document.body.appendChild(styledAlert);
            styledAlert.style.display = 'block';
            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
            await fetchCommunities();
            $('#staticBackdropForLeaveGroup').modal('hide');
        }
    });

    const changeIsActiveForGroup = async (id) => {
        document.getElementById('groupIdForRebuild').value = id;
        const pElement = document.getElementById('RebuildGroupWords');
        pElement.style.fontSize = '20px';
        pElement.style.fontWeight = 'bold';
        pElement.innerHTML = `Are you sure want to use this group back ...`;
        $('#staticBackdropForRebuildGroup').modal('show');
    }
    document.getElementById('rebuildGroupSubmitBtn').addEventListener('click', async () => {
        const id = document.getElementById('groupIdForRebuild').value;
        const data = await fetch(`/api/community/isActive-modify/${id}`, {
            method: 'POST'
        });
        if (!data.ok) {
            alert('Something wrong please try again!');
        } else {
            const res = await data.json();
            let alertMessage = `${res.message}`;
            let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;
            document.body.appendChild(styledAlert);
            styledAlert.style.display = 'block';
            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
            await fetchInactiveCommunities();
            $('#staticBackdropForRebuildGroup').modal('hide');
        }
    });

    const changeStatusForGroup = async (id, access) => {
        document.getElementById('groupId').value = id;
        document.getElementById('changeAccess').value = access;
        const pElement = document.getElementById('changeAccessWords');
        pElement.style.fontSize = '20px';
        pElement.style.fontWeight = 'bold';
        let isPrivate;
        if (access === 'PUBLIC') {
            isPrivate = 'PRIVATE';
        } else {
            isPrivate = 'PUBLIC';
        }
        pElement.innerHTML = `Are you sure want to change this group to <span><strong style="font-style: italic;color: red">${isPrivate}</strong></span> group...`;
        $('#staticBackdropForChangeAccess').modal('show');
    }

    document.getElementById('changeAccessSubmitBtn').addEventListener('click', async () => {
        const cmtId = document.getElementById('groupId').value;
        const access = document.getElementById('changeAccess').value;
        const myObj = {
            communityId: cmtId,
            groupAccess: access
        };
        const data = await fetch(`/api/community/change-access-group`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(myObj)
        });
        if (!data.ok) {
            alert('something wrong please try again!');
        } else {
            const res = await data.json();
            let alertMessage = `${res.message}`;
            let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
            await fetchCommunities();
            $('#staticBackdropForChangeAccess').modal('hide');
        }
    });

    const getUsersByCommunityId = async (id) => {
        const url = `/api/community/user/${id}`;
        const data = await fetch(url);
        if (data.ok) {
            const dataResponse = await data.json();
            console.log('community users', dataResponse);
            return dataResponse;
        }
    };

    async function getCommunityById(id) {
        const response = await fetch(`/api/community/getCommunity/${id}`);
        const data = await response.json();
        return data;
    }

    async function getCurrentUser() {
        const response = await fetch('/api/community/user/current');
        const data = await response.json();
        return data;
    }

    document.getElementById('userSearch').addEventListener('input', function () {
        const searchValue = this.value.toLowerCase();
        const usersList = document.getElementById('usersList');
        const allUsers = document.querySelectorAll('#usersList #container');

        allUsers.forEach(userContainer => {
            const userNameElement = userContainer.querySelector('.user-list-span');
            if (userNameElement) {
                const userName = userNameElement.textContent.toLowerCase();
                if (userName.includes(searchValue)) {
                    userContainer.style.display = 'block';
                } else {
                    userContainer.style.display = 'none';
                }
            }
        });
    });


    async function populateCreateGroupForm(id, name, ownerName, description, image) {
        document.getElementById('communityId1').value = id;
        document.getElementById('name1').value = name;
        document.getElementById('description1').value = description;
        // document.getElementById('image1').innerHTML = '';
        // document.getElementById('image1').value = image;

        const allUsers = await getAllUsers();
        const communityUsers = await getUsersByCommunityId(id);

        const usersNotInCommunity = allUsers.filter(user => !communityUsers.some(communityUser => communityUser.id === user.id));

        const usersList = document.getElementById('usersList');

        usersList.innerHTML = '';


        allUsers.forEach(user => {

            const userContainer = document.createElement('div');
            userContainer.id = "container";
            userContainer.style.padding = '20px';
            userContainer.style.borderRadius = '10px';
            userContainer.style.marginLeft = "280px";

            const container = document.createElement('div');
            container.id = "container1";
            container.style.marginBottom = "80px";

            const photoSpan = document.createElement('span');
            if (user.photo) {
                const userPhoto = document.createElement('img');
                userPhoto.src = user.photo;
                userPhoto.alt = "User's Photo";
                photoSpan.appendChild(userPhoto);
            } else {
                const userPhoto = document.createElement('img');
                userPhoto.src = '/assets/img/default-logo.png';
                userPhoto.alt = "User's Photo";
                photoSpan.appendChild(userPhoto);
            }

            const nameSpan = document.createElement('span');
            nameSpan.classList.add('user-list-span')
            nameSpan.textContent = user.name;

            const br = document.createElement('br');

            const deptSpan = document.createElement('span');
            deptSpan.classList.add('user-list-span')
            deptSpan.textContent = `(${user.dept})`;

            const checkboxInput = document.createElement('input');
            checkboxInput.type = "checkbox";
            checkboxInput.id = `_checkbox${user.id}`;
            checkboxInput.name = "user";
            checkboxInput.value = user.id;
            if (communityUsers.some(communityUser => communityUser.id === user.id)) {
                checkboxInput.checked = true;
                checkboxInput.disabled = true;
            }

            const checkboxLabel = document.createElement('label');
            checkboxLabel.htmlFor = `_checkbox${user.id}`;
            checkboxLabel.className = "form-check-label";
            checkboxLabel.style.marginLeft = "390px";

            const tickMarkDiv = document.createElement('div');
            tickMarkDiv.className = `tick_mark`;

            checkboxLabel.appendChild(tickMarkDiv);
            container.appendChild(photoSpan);
            container.appendChild(nameSpan);
            container.appendChild(br);
            container.appendChild(deptSpan);
            userContainer.appendChild(container);
            userContainer.appendChild(checkboxInput);
            userContainer.appendChild(checkboxLabel);

            usersList.appendChild(userContainer);
        });

        const photoContainer = document.getElementById('photo');
        photoContainer.innerHTML = '';

        if (image) {
            const img = document.createElement('img');
            img.src = `${image}`;
            img.alt = "Community's Photo";
            img.width = 100;
            img.height = 100;
            photoContainer.appendChild(img);
        }

        $('#createGroupModal').modal('show');
    }


    document.getElementById('createGroupBtn').addEventListener('click', async (e) => {
        e.preventDefault();

        const formData = new FormData(document.getElementById('createGroupForm'));

        const url = "/api/community/createGroup";
        const data = await fetch(url, {
            method: 'POST',
            body: formData
        });
        if (data.ok) {
            const result = await data.json();
            await fetchCommunities();
            $('#createGroupModal').modal('hide');
            let alertMessage = result.message;
            let alertStyle = `
            background-color: blue;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
        } else {

            const content = "Error Adding Users";
            let alertMessage = content;
            let alertStyle = `
            background-color: red;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
        }

    });


    let communityIdToDelete;

    const showConfirmationModal = (communityId) => {
        communityIdToDelete = communityId;
        $('#confirmationModal').modal('show');
    }

    const deleteConfirmed = async () => {
        if (communityIdToDelete) {
            await deleteCommunity(communityIdToDelete);
            $('#confirmationModal').modal('hide');
        }
    }

    const deleteCommunity = async (communityId) => {
        const url = `/api/community/delete/${communityId}`;
        const cancelUser = await fetch(url, {
            method: 'DELETE'
        });

        if (!cancelUser.ok) {
            alert('DELETE error');
        }
        let alertMessage = `Delete successful!`;
        let alertStyle = `
            background-color: green;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
        let styledAlert = document.createElement('div');
        styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
        styledAlert.innerHTML = alertMessage;


        document.body.appendChild(styledAlert);


        styledAlert.style.display = 'block';

        setTimeout(function () {
            styledAlert.style.display = 'none';
        }, 3000);
        await fetchCommunities();
    }
    let currentCommunityID;

    document.getElementById('userSearchForKick').addEventListener('input', function () {
        const searchValue = this.value.toLowerCase();
        const usersList = document.getElementById('userList');
        const allUsers = document.querySelectorAll('#userList #container');

        allUsers.forEach(userContainer => {
            const userNameElement = userContainer.querySelector('.kick-user-list-member');
            if (userNameElement) {
                const userName = userNameElement.textContent.toLowerCase();
                if (userName.includes(searchValue)) {
                    userContainer.style.display = 'block';
                } else {
                    userContainer.style.display = 'none';
                }
            }
        });
    });

    async function populateKickGroupForm(id) {
        currentCommunityID = id;
        document.getElementById('communityId').value = id;
        const communityUsers = await getUsersByCommunityId(id);
        const usersList = document.getElementById('userList');
        const kickGroup = document.getElementById('kickGroup');

        const community = await getCommunityById(id);
        const currentUser = await getCurrentUser();

        usersList.innerHTML = '';
        communityUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.id = "container";
                userDiv.style.padding = '20px';
                userDiv.style.borderRadius = '10px';
                userDiv.style.marginLeft = "280px";

                const nestedDiv = document.createElement('div');
                nestedDiv.id = "container1";
                nestedDiv.style.marginBottom = "80px";

                const photoSpan = document.createElement('span');
                const nameSpan = document.createElement('span');
                const deptSpan = document.createElement('span');
                nameSpan.classList.add('kick-user-list-member');
                nameSpan.textContent = user.name;

                const br = document.createElement('br');
                deptSpan.classList.add('kick-user-list-member');
                deptSpan.textContent = `(${user.dept})`;

                if (user.photo) {
                    const photoImg = document.createElement('img');
                    photoImg.src = user.photo;
                    photoImg.alt = "User's Photo";
                    photoSpan.appendChild(photoImg);
                } else {
                    const userPhoto = document.createElement('img');
                    userPhoto.src = '/assets/img/default-logo.png';
                    userPhoto.alt = "User's Photo";
                    photoSpan.appendChild(userPhoto);
                }

                const checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.id = `_kickcheckbox${user.id}`;
                checkbox.name = "userIds";
                checkbox.value = user.id;

                const label = document.createElement('label');
                label.htmlFor = `_kickcheckbox${user.id}`;
                label.className = "form-check-label";
                label.style.marginLeft = "390px";

                const tickMarkDiv = document.createElement('div');
                tickMarkDiv.className = "tick_mark";

                nestedDiv.appendChild(photoSpan);
                nestedDiv.appendChild(nameSpan);
                nestedDiv.appendChild(br);
                nestedDiv.appendChild(deptSpan);
                label.appendChild(tickMarkDiv);
                userDiv.appendChild(nestedDiv);
                userDiv.appendChild(checkbox);
                userDiv.appendChild(label);

                usersList.appendChild(userDiv);
        });

        $('#kickModal').modal('show');
    }

    document.getElementById('kickGroupBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        document.getElementById('communityId').value = currentCommunityID;
        const formData = new FormData(document.getElementById('kickForm'));
        const url = "/api/community/kick";
        const data = await fetch(url, {
            method: 'POST',
            body: formData
        });

        if (data.ok) {
            const result = await data.json();
            await fetchCommunities();
            const content = "Kicked Successfully";
            $('#kickModal').modal('hide');
            let alertMessage = content;
            let alertStyle = `
            background-color: blue;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
        } else {
            const content = 'Error kicking users from community';
            let alertMessage = content;
            let alertStyle = `
            background-color: red;
            color: white;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function () {
                styledAlert.style.display = 'none';
            }, 3000);
        }
    });

    document.getElementById('createGroupModalCloseBtn').addEventListener('click', function () {
        $('#createGroupModal').modal('hide');
    });
    document.getElementById('kickModalCloseBtn').addEventListener('click', function () {
        $('#kickModal').modal('hide');
    });

    document.getElementById('addOwnerCloseBtn').addEventListener('click', function () {
        $('#staticBackdropForAddOwner').modal('hide');
    });

    document.getElementById('changeAccessCloseBtn').addEventListener('click', function () {
        $('#staticBackdropForChangeAccess').modal('hide');
    });

    document.getElementById('confimationModelCloseBtn').addEventListener('click', function () {
        $('#confirmationModal').modal('hide');
    });

    document.getElementById('rebuildGroupCloseBtn').addEventListener('click', function () {
        $('#staticBackdropForRebuildGroup').modal('hide');
    });

    document.getElementById('leaveGroupCloseBtn').addEventListener('click', function () {
        $('#staticBackdropForLeaveGroup').modal('hide');
    });

    const goToChatRoom = (id) => {
        localStorage.setItem('chatRoomIdForGroup', id);
        window.location.href = `/api/community/goMal-chatRoom`;
    }

    let currentPageForEach = '0';
    let isFetchingForEach = false;
    let hasMoreForEach = true;

    async function fetchNotificationPerPage(){
        isFetchingForEach = true;
        let response = await fetch(`/user/get-all-noti/${currentPageForEach}`, {
            method: 'GET'
        });
        let root = document.getElementById('root');
        root.innerHTML = '';

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        let data = await response.json();
        isFetchingForEach = false;
        if (data.length === 0) {
            hasMoreForEach = false;
            return;
        }
        for (let noti of data) {
            let divElement = document.createElement('div');
            divElement.classList.add('notificationForNoti', `postId-${noti.postId}`);
            divElement.id = `noti-deleted-${noti.id}`;
            divElement.dataset.postId = noti.postId;
            divElement.style.borderRadius = '10px';
            divElement.style.width = '380px';
            attachNotificationEventListenersForEach();
            console.log("GetIDFORMEnto",noti.mentionId)
            const trashIcon = document.createElement('i');
            trashIcon.id = `trashIcon-deleted-${noti.id}`
            trashIcon.classList.add('fa-solid','fa-trash-can');
            trashIcon.style.marginLeft = '400px';
            trashIcon.addEventListener('click',async () => {
                const notiID = noti.id;
                await deletedNotificationForEach(notiID);
            });
            const spEle = document.createElement('span');
            spEle.style.marginTop = '-40px';
            spEle.appendChild(trashIcon);
            if (noti.reactId && !noti.commentId && !noti.replyId) {
                const reactType = await fetchReactTypeForNotificationForEach(noti.reactId);
                console.log('React Type user', reactType.user.staffId)
                const user = await fetchUserDataByPostedUserForEach(reactType.user.staffId);
                const photo = user.photo || '/static/assets/img/default-logo.png';
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';
                const pElement = document.createElement('p');
                let imgReactElement = document.createElement('img');
                if (reactType.type) {
                    imgReactElement.src = `/static/assets/img/${reactType.type.toLowerCase()}.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + `${noti.content}`;
                } else {
                    imgReactElement.src = `/static/assets/img/cancel.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + ` canceled reaction in your post`;
                }
                divElement.appendChild(imgElement);
                divElement.appendChild(imgReactElement);
                divElement.appendChild(pElement);
            }

            if (noti.commentId && !noti.replyId && !noti.reactId) {
                const commentUser = await fetchCommetedUserForEach(noti.commentId);
                console.log('Comment user', commentUser.user.name)
                const photo = commentUser.user.photo || '/static/assets/img/default-logo.png';
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';

                const pElement = document.createElement('p');
                pElement.style.display = 'inline-block';
                pElement.style.marginLeft = '10px'; // Adjust margin as needed
                pElement.innerHTML = `${commentUser.user.name} commented to your post`;

                divElement.appendChild(imgElement);
                divElement.appendChild(pElement);
            }

            if (noti.commentId && noti.replyId && !noti.reactId) {
                const replyUser = await fetchRepliedUserForDataForEach(noti.replyId);
                console.log('photo', replyUser.user.photo);
                console.log('photo', replyUser.user.staffId);
                const photo = replyUser.user.photo ||  '/static/assets/img/default-logo.png';
                console.log('Reply user', replyUser.user.name);
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';

                const pElement = document.createElement('p');
                pElement.style.display = 'inline-block';
                pElement.style.marginLeft = '10px'; // Adjust margin as needed
                pElement.innerHTML = `${replyUser.user.name} replied to your comment`;

                divElement.appendChild(imgElement);
                divElement.appendChild(pElement);
            }


            if (noti.reactId && noti.commentId && !noti.replyId) {
                const reactType = await fetchReactTypeForNotificationForEach(noti.reactId);
                console.log('React Type user', reactType.user.staffId)
                const user = await fetchUserDataByPostedUserForEach(reactType.user.staffId);
                const photo = user.photo ||  '/static/assets/img/default-logo.png';
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';
                const pElement = document.createElement('p');
                let imgReactElement = document.createElement('img');
                if (reactType.type) {
                    imgReactElement.src = `/static/assets/img/${reactType.type.toLowerCase()}.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + `${reactType.type}` + ' your comment';
                } else {
                    imgReactElement.src = `/static/assets/img/cancel.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + ` canceled reaction in` + ' your comment';
                }
                divElement.appendChild(imgElement);
                divElement.appendChild(imgReactElement);
                divElement.appendChild(pElement);
            }

            if (noti.reactId && !noti.commentId && noti.replyId) {
                const reactType = await fetchReactTypeForNotificationForEach(noti.reactId);
                console.log('React Type user', reactType.user.staffId)
                const user = await fetchUserDataByPostedUserForEach(reactType.user.staffId);
                const photo = user.photo ||  '/static/assets/img/default-logo.png';
                let imgElement = document.createElement('img');
                imgElement.src = `${photo}`;
                imgElement.width = 40;
                imgElement.height = 40;
                imgElement.style.borderRadius = '50%';
                const pElement = document.createElement('p');
                let imgReactElement = document.createElement('img');
                if (reactType.type) {
                    imgReactElement.src = `/static/assets/img/${reactType.type.toLowerCase()}.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + `${reactType.type}` + ' your reply';
                } else {
                    imgReactElement.src = `/static/assets/img/cancel.png`;
                    imgReactElement.width = 20;
                    imgReactElement.height = 20;

                    imgElement.style.display = 'inline-block';
                    imgReactElement.style.display = 'inline-block';
                    imgReactElement.style.marginBottom = '-20px';
                    imgReactElement.style.marginLeft = '-10px';
                    pElement.style.display = 'inline-block';
                    pElement.innerHTML = `${user.name}` + ` canceled reaction in ` + ' your reply';
                }
                divElement.appendChild(imgElement);
                divElement.appendChild(imgReactElement);
                divElement.appendChild(pElement);
            }

            if (noti.mentionId) {
                const mention = await getMentionByIdForEach(noti.mentionId);
                console.log("SDFDSF555"+mention.postedUserId)
                console.log("SDFDSF555"+mention.post.id)
                if(!mention.comment) {
                    const getUser = await getMentionUserForEach(mention.postedUserId);
                    const photo = getUser.photo || '/static/assets/img/default-logo.png';
                    console.log("MenitonUSer", getUser.name)
                    let imgElement = document.createElement('img');
                    imgElement.src = `${photo}`;
                    imgElement.width = 40;
                    imgElement.height = 40;
                    imgElement.style.borderRadius = '50%';

                    const pElement = document.createElement('p');
                    pElement.style.display = 'inline-block';
                    pElement.style.marginLeft = '10px'; // Adjust margin as needed
                    pElement.innerHTML = `${getUser.name} mentioned you in a post`;

                    divElement.appendChild(imgElement);
                    divElement.appendChild(pElement);
                }else{
                    const getUser = await getMentionUserForEach(mention.postedUserId);
                    const photo = getUser.photo ||  '/static/assets/img/default-logo.png';
                    console.log("MenitonUSer", getUser.name)
                    let imgElement = document.createElement('img');
                    imgElement.src = `${photo}`;
                    imgElement.width = 40;
                    imgElement.height = 40;
                    imgElement.style.borderRadius = '50%';

                    const pElement = document.createElement('p');
                    pElement.style.display = 'inline-block';
                    pElement.style.marginLeft = '10px'; // Adjust margin as needed
                    pElement.innerHTML = `${getUser.name} mentioned you in a comment`;

                    divElement.appendChild(imgElement);
                    divElement.appendChild(pElement);
                }
            }
            const container =  document.createElement('div');
            container.classList.add('container-trash-div')
            container.style.display = 'inline-grid';
            container.appendChild(divElement);
            container.appendChild(spEle);
            root.appendChild(container);
        }
    };

    async function fetchReactTypeForNotificationForEach(id){
        const reactType = await fetch(`/user/like-noti-type/${id}`);
        const reactDataType = await reactType.json();
        return reactDataType;
    }

    async function fetchUserDataByPostedUserForEach(id){
        const fetchUserData = await fetch(`/get-userData/${id}`);
        if (!fetchUserData.ok) {
            alert('Invalid user');
        }
        const userDataForAll = await fetchUserData.json();
        return userDataForAll;
    };

    async function fetchCommetedUserForEach(id){
        const commentUser = await fetch(`/user/comment-user-data/${id}`);
        if (!commentUser.ok) {
            alert('something wrong');
        }
        const commentUserData = await commentUser.json();
        return commentUserData;
    }

    async function fetchRepliedUserForDataForEach(id){
        const fetchDataForUser = await fetch(`/user/reply-user-data/${id}`);
        const userDataForReply = await fetchDataForUser.json();
        return userDataForReply;
    };

    async function getMentionUserForEach(id){
        const data = await fetch(`/getData-mention/${id}`);
        const res = await data.json();
        return res;
    }

    async function getMentionByIdForEach(id){
        const data = await fetch(`/get-mentionUser/${id}`);
        const res = await data.json();
        return res;
    }

    async function checkStatusForUser(){
        const data = await fetch(`/user/check-notiStatus`);
        const res = await data.json();
        return res;
    }

    async function deletedNotificationForEach(id){
        const deleteNoti = await fetch(`/delete-noti/${id}`,{
            method:'DELETE'
        });
        if(!deleteNoti.ok){
            alert('something wrong please try again later');
        }else {
            const divElement = document.getElementById(`noti-deleted-${id}`);
            const trashIconEl = document.getElementById(`trashIcon-deleted-${id}`);
            if (divElement && trashIconEl ) {
                console.log("it's fine",id)
                divElement.remove();
                trashIconEl.remove();
            }
        }
    }

    function attachNotificationEventListenersForEach(){
        const notificationElements = document.querySelectorAll('.notificationForNoti');
        notificationElements.forEach(notificationElement => {
            notificationElement.addEventListener('click', async function() {
                console.log("Clicked on notification element");
                const postId = this.dataset.postId; // 'this' refers to the current notification element
                console.log('PostId', postId);
                const postElement = document.getElementById(postId);
                const pElement = this.querySelector('p');
                if (postElement) {
                    postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }else{
                    if (pElement) {
                        localStorage.setItem('commentOrReply',pElement.textContent);
                    }
                    localStorage.setItem('trendPostIdForSinglePost',postId);
                    window.location.href = `/user-details-post`
                }
            });
        });
    };

    document.addEventListener('DOMContentLoaded', async () => {
        // await fetchNotificationPerPage();
        const modalContent = document.getElementById('content-notification');
        modalContent.addEventListener('scroll', async () => {
            if (isFetchingForEach || !hasMoreForEach) {
                console.log('currentPage', currentPageForEach);
                return;
            }

            if (modalContent.scrollTop + modalContent.clientHeight >= modalContent.scrollHeight) {
                currentPageForEach++;
                console.log('currentPage', currentPageForEach);
                await fetchNotificationPerPage();
            }
        });
    });

    //for invitation start

    async function showInvitation(){
        const showCount = document.getElementById('inviteMessageCount');
        const size = await getInvitation();
        console.log('adfdfdfdfdf',size)
        if(size === 0){
            showCount.innerText = ''
        }else{
            showCount.innerText = size;
        }
    }

    async function getInvitedUserById(id){
        const data = await fetch(`/user/get-invited-user/${id}`);
        const res = await data.json();
        return res;
    }

    document.addEventListener('DOMContentLoaded',async function () {
        await showInvitation();
        await showEmptyContent();
        await getInvitation();
        await getAllInvitations();
    });

    async function getInvitation(){
        const msgCount = await fetch('/user/invited-user-count');
        const msgSize = await msgCount.json();
        return msgSize;
    }

    async function showEmptyContent(){
        const invitations = await fetchInvitationMessage();
        const root = document.getElementById('messageRoot');
        if(invitations.length === 0){
            root.style.fontSize = '30px';
            root.innerHTML = 'There is no invitations yet...';
        }
    }


    async function getAllInvitations(){
        const invitation = await fetchInvitationMessage();
        for (const i of invitation) {
            await displayMessageForInvitation(i.id,i.community.image,i.community.name,i.community.id,i.senderId);
        }
    }

    async function displayMessageForInvitation(id,image,name,communityId,userId){
        const root = document.getElementById('messageRoot');
        const divElement = document.createElement('div');
        divElement.classList.add(`invitation-message-${id}`)
        divElement.style.padding = '15px';
        divElement.style.border = '1px solid black';
        divElement.style.borderRadius = '10px';
        divElement.style.margin = '3px';
        divElement.style.marginLeft = '55px';
        divElement.style.marginTop = '-35px';
        divElement.style.borderBottomLeftRadius = '40px';
        divElement.style.backgroundColor = 'lightgrey';
        const invitedUser = await getInvitedUserById(userId);
        const spElementForImage = document.createElement('span');
        spElementForImage.classList.add(`span-image-${id}`);
        const imgTag = document.createElement('img');
        const photo = `${image}`|| `/static/assets/img/default-logo.png`;
        imgTag.src = photo;
        imgTag.style.width = '50px';
        imgTag.style.height = '50px';
        imgTag.style.borderRadius = '50%';
        spElementForImage.appendChild(imgTag);
        const spElementForContent = document.createElement('span');
        spElementForContent.innerHTML = `${invitedUser.name} (${invitedUser.dept}) invited you to join ${name} group`;
        const buttonsWrapper = document.createElement('div');
        buttonsWrapper.classList.add(`button-wrapper-${id}`)
        buttonsWrapper.style.marginLeft = '220px';
        const acceptButton = document.createElement('button');
        acceptButton.innerHTML = 'Accept'
        acceptButton.classList.add('btn','btn-outline-success')
        acceptButton.id = id;
        acceptButton.addEventListener('click',async () => {
            await acceptInvitation(id,communityId,name);
        });
        const denyButton = document.createElement('button');
        denyButton.innerHTML = 'Reject';
        denyButton.classList.add('btn','btn-outline-danger')
        denyButton.addEventListener('click', async () => {
            await rejectInvitation(id);
        });
        buttonsWrapper.appendChild(acceptButton);
        buttonsWrapper.appendChild(denyButton);
        divElement.appendChild(spElementForContent);
        // divElement.appendChild(buttonsWrapper);
        const allWrapDiv = document.createElement('div');
        allWrapDiv.classList.add(`all-wrap-div-${id}`);
        allWrapDiv.appendChild(spElementForImage)
        allWrapDiv.appendChild(divElement);
        allWrapDiv.appendChild(buttonsWrapper);
        root.appendChild(allWrapDiv);
    }


    async function acceptInvitation(id,communityId,name){
        const data = await fetch(`/user/accept-invitation/${id}/${communityId}`);
        const response = await data.json();
        if(response){
            const divEl = document.querySelector(`.all-wrap-div-${id}`);
            if(divEl){
                await showInvitation();
                divEl.remove();
            }
            let alertMessage = response.message + ` ${name}`;
            let alertStyle = `
            background-color: white;
            color: blue;
            border: 1px solid #cc0000;
            border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function() {
                styledAlert.style.display = 'none';
            }, 5000);
        }
    }


    async function rejectInvitation(id){
        const data = await fetch(`/user/reject-invitation/${id}`);
        const response = await data.json();
        if(response){
            const divEl = document.querySelector(`.all-wrap-div-${id}`);
            if(divEl){
                await showInvitation();
                divEl.remove();

            }
            let alertMessage = response.message;
            let alertStyle = `
            background-color: #ffcccc;
            color: #cc0000;
            border: 1px solid #cc0000;
             border-radius: 15px;
        `;
            let styledAlert = document.createElement('div');
            styledAlert.style.cssText = `
            ${alertStyle}
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10000;
            display: none;
        `;
            styledAlert.innerHTML = alertMessage;


            document.body.appendChild(styledAlert);


            styledAlert.style.display = 'block';

            setTimeout(function() {
                styledAlert.style.display = 'none';
            }, 3000);
        }
    }

    async function fetchInvitationMessage(){
        const data = await fetch('/user/invited-user-display');
        const response = await data.json();
        return response;
    }

    //for invitation end

</script>
</body>
</html>